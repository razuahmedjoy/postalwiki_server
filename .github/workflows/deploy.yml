name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install Dependencies
      run: npm install
      
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 1337
        script: |
          # Install Node.js 18 if not installed
          if ! command -v node &> /dev/null || [ "$(node -v | cut -d'v' -f2 | cut -d'.' -f1)" -lt 18 ]; then
            echo "Installing Node.js 18..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Create directory if it doesn't exist
          mkdir -p /home/lysnar/api.postalwiki.co.uk
          cd /home/lysnar/api.postalwiki.co.uk
          
          # Initialize git if not already initialized
          if [ ! -d .git ]; then
            git init
            git remote add origin ${{ secrets.REPOSITORY_URL }}
          fi
          
          # Pull the latest code
          git fetch origin
          git reset --hard origin/main
          
          # Install dependencies
          npm install
          
          # Set proper permissions
          # First, make sure lysnar owns the directory
          chown -R lysnar:lysnar /home/lysnar/api.postalwiki.co.uk
          # Then set permissions that allow nobody (Apache) to read
          chmod -R 755 /home/lysnar/api.postalwiki.co.uk
          
          # Install PM2 globally for the current user
          if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2 globally..."
              npm install -g pm2 --location=global
          fi
          
          # Create ecosystem file for PM2
          cat > ecosystem.config.js << 'EOL'
          module.exports = {
            apps: [{
              name: "postalwiki-api",
              script: "npm",
              args: "start",
              env: {
                NODE_ENV: "production",
                PORT: 3000
              }
            }]
          }
          EOL
          
          # Check if the process exists
          if pm2 list | grep -q "postalwiki-api"; then
              echo "Restarting existing application..."
              pm2 restart postalwiki-api
          else
              echo "Starting application for the first time..."
              pm2 start ecosystem.config.js
              pm2 save
              pm2 startup
          fi
          
          # Reload Apache (using sudo since it's required)
          sudo /usr/local/apache/bin/apachectl graceful 